동기:
수업 시간에 옵션 가격 이론 중 하나인 풋-콜 패리티(Put-Call Parity)에 대해 간단히 배우면서, 이론적으로 동일한 가치를 가져야 하는 콜옵션, 풋옵션, 그리고 선물 가격 사이에 차이가 발생하면 차익거래(Arbitrage) 기회가 생기는데 이것이 실제로 실시간으로 구현 가능한지가 궁금하여 시도해보게 되었습니다. 이를 통해 파생상품 시장에서의 가격 균형 관계를 좀 더 직관적으로 체험하고, 금융 API와 데이터 통신의 실제 적용 사례도 익히고자 했습니다.

프로젝트 개요:
이 프로젝트는 국내 주식 파생상품(선물, 콜옵션, 풋옵션)의 실시간 시세 데이터를 수신하여, 세 상품 간의 차익거래 기회를 탐지하는 시스템입니다. 한국투자증권에서 제공하는 Open API (모의투자 전용)를 활용하여 데이터를 WebSocket으로 수신하고, Python을 통해 간단한 수식으로 차익을 계산합니다.
시세 데이터는 다음 세 가지 상품에서 수신됩니다:
* 선물: 101W07 (7월 만기 KOSPI200 선물)
* 콜옵션: 201W07340 (행사가 340인 콜옵션)
* 풋옵션: 301W07340 (행사가 340인 풋옵션)

가정 및 설정:
이 코드는 아래와 같은 전제와 설정을 기반으로 동작합니다:
1. 모의투자 계정 기반
    * 한국투자증권 KIS Developers에서 발급받은 APP_KEY와 APP_SECRET을 이용해 인증 토큰(approval_key)을 발급받습니다.
    * 실제 거래는 이뤄지지 않으며, 실시간 데이터 수신까지만 이뤄집니다.
    * 한국투자증권에서 제가 직접 모의투자 계좌를 만들고 APP_KEY를 받아서 실제로 사용해보았습니다.
    * 사실 이 부분이 가장 어려웠습니다. APP_KEY를 구동하는 시도에서 많은 시간이 소비되었습니다.
2. 시장 가격의 효율성과 옵션 가격 이론
    * 기본적인 가정은 콜-풋 패리티(Call-Put Parity)를 바탕으로 한 차익 분석입니다: C - P = F - K C: 콜옵션 가격 / P: 풋옵션 가격 / F: 선물 가격 / K: 행사가
3. 차익 탐지 기준
    * |콜 - 풋 - (선물 - 행사가)| > 0.5인 경우를 차익거래 기회로 판단합니다.
    * 실제 시장에서는 수수료, 스프레드, 체결 가능성 등을 반영해야 하지만, 모의 시뮬레이션에서는 단순 비교로 처리합니다.
4. WebSocket 기반 실시간 시세 수신
    * WebSocket 연결을 통해 세 종목에 대한 실시간 가격이 들어오면 그때마다 수식 계산을 수행합니다.

작동 원리 (흐름)
1. 인증 토큰 발급 (REST API)
    * get_approval_key() 함수를 통해 APP_KEY와 APP_SECRET을 사용하여 approval_key를 받습니다.
2. WebSocket 연결
    * 모의투자용 WebSocket 서버에 연결 후, 세 종목(선물/콜/풋)에 대해 tr_id를 다르게 하여 실시간 구독을 요청합니다.
3. 데이터 수신 및 차익 계산
    * 각 종목의 시세 데이터가 들어오면 on_message() 함수가 실행됩니다.
    * 가격이 세 종목 모두 수신된 이후에는 차익 수식 계산을 수행하고, 조건을 만족하면 차익거래 기회 탐지! 메시지를 출력합니다.
4. 자동 멀티스레딩 실행
    * WebSocket 연결은 Python의 threading 모듈을 이용하여 병렬로 계속 실행됩니다.

결과

201W07340: 11.34
301W07340: 6.65
101W07: 405.17
콜: 11.34, 풋: 6.65, 선물: 405.17 → 차익 = -0.48

201W07340: 11.37
301W07340: 6.70
101W07: 405.07
콜: 11.37, 풋: 6.70, 선물: 405.07 → 차익 = -0.41

201W07340: 11.25
301W07340: 6.59
101W07: 405.12
콜: 11.25, 풋: 6.59, 선물: 405.12 → 차익 = -0.46

201W07340: 11.07
301W07340: 6.67
101W07: 405.04
콜: 11.07, 풋: 6.67, 선물: 405.04 → 차익 = -0.65  >>> 차익거래 기회 탐지

결론 및 인사이트

시세가 실시간으로 조금씩 바뀌는 모습을 지켜보며, 이론적으로는 불일치가 생기면 차익이 생겨야 한다고 배웠지만, 실제 가격은 대부분 패리티 이론을 잘 만족하고 있어 차익거래 기회가 자주 발생하지 않는다는 점을 직접 체감할 수 있었습니다. 대략 5분 정도를 보고 있었는데 차익 거래가 잘 보이지 않았습니다. 가격 간의 불균형이 일정 수준 이상으로 벌어지는 경우는 극히 드물었으며, 이는 실제 시장이 매우 효율적으로 작동하고 있음을 반영합니다.

또한, 시뮬레이션 도중 차익거래 기회가 발생하는 순간까지 한 틱씩 분석하며 내려가는 과정은 이론이 어떻게 실시간 데이터에서 작동하는지를 직관적으로 이해하는 데 큰 도움이 되었습니다. 각 종목 가격이 얼마나 세밀하게 움직이며, 미세한 차이가 결과에 어떤 영향을 미치는지를 명확하게 확인할 수 있었습니다.

* 시장 가격이 전반적으로 효율적 → 콜·풋·선물 간의 패리티 관계가 대부분 유지되고 있어 차익이 자주 발생하지 않음. 이론적으로 설명되는 시장 효율성이 실제 데이터에서도 관찰됨.
* 일시적인 비효율 탐지 가능 → 실시간으로 데이터를 처리하면, 극히 짧은 순간의 가격 불일치로 인해 차익 탐지 기회가 드물게 발생하며, 이는 자동화된 알고리즘이 아니면 포착이 어렵다.
* 이론적 수익 가능성 확인 → 단순 시뮬레이션이지만, Put-Call Parity에 기반한 전략이 일정 조건에서 작동 가능함을 확인함.
* 차익 조건이 충족되더라도 실제로 거래를 체결할 수 있느냐는 별개의 문제입니다. 특히 옵션 시장은 호가 간격이 넓거나 유동성이 낮은 경우가 많아, 단순한 수식적 차익이 실제 수익으로 연결되기는 어렵습니다.
* 수업에서 배운 이론이 시장 데이터에 어떻게 반영되는지 관찰할 수 있었다는 점이 가장 의미 있었던 부분입니다. 특히 패리티 이론이 현실에서는 거의 항상 유지된다는 점은 금융시장 효율성에 대한 중요한 통찰을 제공합니다.
* 단순한 수식 구현을 넘어, 실시간 데이터 처리, 인증, WebSocket 핸들링, 멀티스레딩 등 프로그래밍적으로도 실제 트레이딩 시스템의 작동 원리를 작게나마 경험해볼 수 있었습니다.

한계점 및 리스크
1. 수익 기회 대부분이 이론적
    * 거래 비용, 호가 차이, 체결 가능성 등을 고려하지 않았기 때문에 탐지된 3% 중 실제 수익으로 연결되는 경우는 훨씬 적을 가능성이 높습니다
2. 실시간성의 민감도
    * tick 간 시간차나 지연으로 인해 차익 기회가 실제로는 이미 사라진 경우도 존재할 수 있습니다
3. 기준값 민감성
    * |차익| > 0.5는 임의 기준이며, 기준을 ±0.3으로 낮추면 탐지율은 급격히 높아지고, ±1.0으로 올리면 탐지 기회는 거의 사라짐. 전략 설계 시 기준 설정의 정당성 확보가 중요합니다
4. 코드가 평일 낮에 하루 잘 구동 되다가 그 이후로 서버와의 연결이 불안정하다며 잘 구동 안되는 부분도 있었습니다. 그래서 한 번 성공하고 그 뒤로는 결과를 보기가 조금 어려운 부분이 있었습니다.




사실 위의 실시간이 APP_KEY가 잘 구현이 안되는 경우가 너무 많았어서 추가적으로 BS와 현재가의 차익으로 매수매도 판단을 분석해보는 모델을 짜보았습니다.

프로젝트 개요
이 프로젝트는 특정 종목(AAPL)을 대상으로 다양한 행사가의 콜옵션을 수집하고, Black-Scholes 모형을 이용해 옵션의 이론가격을 계산한 뒤 실제 시장 가격과 비교하여 괴리를 분석합니다. 괴리가 일정 수준 이상일 경우 과대 또는 과소평가로 판단하고, 이에 따라 매수 또는 매도 전략을 추천합니다. 단순한 데이터 시각화나 가격 확인을 넘어, 옵션 시장에서의 비효율성과 차익기회를 탐색하는 실질적인 분석 도구로 기능합니다.

가정 및 산출 근거
1. 옵션 가격 결정 모델
* Black-Scholes 모델 사용
* 이 모델은 유럽형 옵션의 이론가 산출에 널리 사용되며, 기초자산이 배당을 지급하지 않는다는 가정하에 단일 변동성과 이자율로 계산됨
2. 파라미터 설정
A) 무위험이자율 r = 0.052 (5.2%)
산출 근거
* 무위험이자율은 옵션 가격 모델에서 미래의 현금 흐름(예: 행사가격 K)을 현재가치로 할인할 때 사용되는 시장 기준금리입니다.
* 일반적으로는 미국 국채 수익률(UST) 중 만기일과 가장 유사한 기간의 금리를 사용합니다.
* 예: 만기일이 30일 남았다면, 1개월물 T-Bill 금리를, 3개월이면 13-week Treasury bill을 기준으로 사용
최근 기준 예시 (2025년 6월 기준):
만기	금리 (%)
1개월	약 5.33%
3개월	약 5.30%
1년	약 5.20%
→ 따라서, r = 0.052는 만기 1개월 전후 옵션에 대해 보수적으로 가정한 수치입니다.

b) 변동성 σ = 0.25 (25%)
산출 근거
* σ (Volatility)**는 주가의 연간 표준편차(변동성)를 의미하며, Black-Scholes에서 옵션 가치에 핵심적으로 작용합니다.
* 실무에서는 두 가지 방식으로 접근합니다:
(1) Realized Volatility
* 실제 주가의 일간 수익률 표준편차를 252거래일 기준 연율화 cpp
* 예: AAPL 30일 수익률 std ≈ 1.6% → 연율화 ≈ 1.6% × sqrt(252) ≈ 25.4%
(2) Implied Volatility (IV)
* 시장에서 거래되는 옵션의 가격으로부터 역산한 변동성
* 실제 yfinance.Ticker("AAPL").option_chain()으로 확인 가능
* ATM 구간의 IV 평균이 보통 0.22 ~ 0.28 사이에 존재
→ 따라서, σ = 0.25는 실현 변동성과 암묵 변동성 모두를 반영한 중립적 추정값입니다.

3. 전략 판단 기준
* 시장가 - 이론가의 절대값이 0.5 이상인 경우 차익 기회로 간주
* 수수료, 슬리피지 등 거래비용을 0.15 달러로 추정하여 수익성 반영
* 괴리 방향에 따라 전략 구분:
    * 시장가 > 이론가: 고평가 → 콜옵션 매도
    * 시장가 < 이론가: 저평가 → 콜옵션 매수

작동 원리
1. 데이터 수집
* yfinance 라이브러리를 통해 AAPL의 최신 주가와 최근 만기 콜옵션 체인을 가져옴
* 옵션 체인에는 행사가, 잔존만기, 시장가 등의 정보가 포함되어 있음
2. 이론가 계산
* 각 옵션에 대해 Black-Scholes 공식을 이용해 이론가(theo)를 산출
* 잔존만기 T는 (옵션 만기일 - 오늘 날짜)/365로 계산됨
3. 전략 판단 및 수익 분석
* 시장가격과 이론가격의 괴리(diff)를 계산
* 절대값이 기준치를 초과하면 매수 또는 매도 전략을 할당
* 예상 수익은 |diff| - 수수료로 계산되며, 0 이하일 경우 전략에서 제외
4. 결과 출력 및 시각화
* 전략이 추천된 옵션 목록을 테이블로 출력
* 선택된 전략들의 순서별 누적 수익을 시각화하여 포트폴리오 전체 흐름 파악 가능

결과
￼
의미 해석
1. 저평가 콜옵션이 대다수 (CALL 매수 전략)
* 총 16개의 콜옵션이 BS 이론가보다 시장가가 낮게 거래되고 있음
* 특히 아래 종목:
    * 145.0 행사가: 시장가 51.33 vs 이론가 56 → 괴리 -4.67 → 매수전략 예상 수익 4.52
    * 170.0: 괴리 -3.18 → 매수전략 예상 수익 3.03
    * 177.5: 괴리 -2.37 → 예상 수익 2.22
* 이들은 시장 참여자들이 변동성을 덜 반영하거나, 수요가 부족한 옵션일 가능성
2. 소수지만 고평가된 옵션 (CALL 매도 전략)도 존재
* 200.0 ~ 205.0 구간에서 시장가가 이론가보다 높게 형성
* 200.0: 시장가 3.34 vs 이론가 2.37 → 고평가 → 매도 전략 추천
* 이 옵션들은 시장 기대 수익률이 과하게 높아졌거나, 수요 과잉일 수 있음
3. 종합
대부분의 콜옵션이 이론가 대비 상대적으로 저평가되어 있음
1~4달러 수준의 예상 차익이 있는 기회 다수 포착됨
다만 실제 거래로 확장하기 위해선 다음 조건들 추가 검토 필요:
* 매도·매수 호가 간격 (Bid/Ask Spread)
* 거래량과 체결 가능성
* 옵션 만기까지의 잔존 기간
* Implied Volatility와 Realized Volatility 간 괴리 여부

코드 및 모델의 한계점
* BS 모델 고정 파라미터 사용
    * 변동성 σ = 0.25는 모든 행사가에 동일하게 적용됨 → 실제 옵션시장은 행사가에 따라 **IV(Volatility Smile)**이 다름
    * 이자율 r = 0.052도 고정되어 있어 잔존만기별 할인율 반영 부족
* 실제 체결 가능성 고려 없음
    * 분석은 이론상 수익 가능성만 평가하며, 실제 주문이 체결될 수 있을지에 대한 정보 부족
    * Bid/Ask 스프레드, 호가 수량, 체결 속도 등 미반영
* 거래비용 추정이 고정
    * 수수료, 슬리피지 비용을 단순히 0.15달러로 고정 → 종목, 증권사, 옵션 가격에 따라 실제 거래비용은 훨씬 다양함
* 미국 옵션임에도 유럽형 모델 사용
    * Black-Scholes는 유럽형 옵션을 전제로 함 → AAPL 옵션은 미국형(American)으로, 조기행사 가능성이 있음 → 특히 배당락일 전후, ATM 옵션에서는 왜곡 발생 가능
* 배당금 고려 안함
    * AAPL은 정기 배당을 지급하는 종목인데, 모델에는 반영되어 있지 않음 → 배당일 직전의 옵션가 왜곡이 무시됨
* 잔존만기 계산 단순화
    * 잔존일수 T = (만기일 - 오늘)/365 식으로 계산 → 실제로는 시간 기준 (거래 시간 단위), 휴장일, 배당일 등도 고려해야 함

현실적인 투자 적용 리스크
* 시장 가격 지연
    * yfinance에서 가져오는 옵션 가격은 실시간이 아니며 최대 15~20분 지연 가능 → 고빈도 전략에는 부적합
* 거래 가능성 불확실
    * 거래량(Volume), 미결제약정(Open Interest)을 고려하지 않기 때문에, 아무리 저평가되어도 유동성이 없으면 매매 불가
* 전략 백테스트 부재
    * 해당 분석은 단일 시점 기준이며, 과거 시계열 데이터를 통한 검증 없음 → 전략 일관성, 리스크 조정 수익률, 최대 낙폭(MDD) 등 지표 부재
* IV 변동성 리스크 미반영
    * 시간이 지나면서 IV가 급등하거나 급락할 경우, 이론가 계산 자체가 틀어질 수 있음 → 예를 들어, 시장 이벤트 전후로 전략 성과가 급변할 수 있음
